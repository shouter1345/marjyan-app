import numpy as np

class Matrix4x4:
    def __init__(self, matrix=None):
        """4x4行列を初期化"""
        if matrix is None:
            self.matrix = np.zeros((4, 4))
        else:
            self.matrix = np.array(matrix)
            if self.matrix.shape != (4, 4):
                raise ValueError("行列は4x4である必要があります")
    
    def __str__(self):
        """行列を見やすい形で表示"""
        result = ""
        for row in self.matrix:
            result += "[ " + " ".join(f"{x:8.2f}" for x in row) + " ]\n"
        return result
    
    def add(self, other):
        """行列の加算"""
        if isinstance(other, Matrix4x4):
            return Matrix4x4(self.matrix + other.matrix)
        else:
            raise TypeError("Matrix4x4オブジェクトが必要です")
    
    def subtract(self, other):
        """行列の減算"""
        if isinstance(other, Matrix4x4):
            return Matrix4x4(self.matrix - other.matrix)
        else:
            raise TypeError("Matrix4x4オブジェクトが必要です")
    
    def multiply(self, other):
        """行列の乗算"""
        if isinstance(other, Matrix4x4):
            return Matrix4x4(np.dot(self.matrix, other.matrix))
        elif isinstance(other, (int, float)):
            # スカラー倍
            return Matrix4x4(self.matrix * other)
        else:
            raise TypeError("Matrix4x4オブジェクトまたは数値が必要です")
    
    def transpose(self):
        """行列の転置"""
        return Matrix4x4(self.matrix.T)
    
    def determinant(self):
        """行列式の計算"""
        return np.linalg.det(self.matrix)
    
    def inverse(self):
        """逆行列の計算"""
        try:
            return Matrix4x4(np.linalg.inv(self.matrix))
        except np.linalg.LinAlgError:
            raise ValueError("この行列は逆行列を持ちません（特異行列）")
    
    def trace(self):
        """対角和（トレース）の計算"""
        return np.trace(self.matrix)

# 使用例とテスト
def main():
    print("=== 4x4行列計算プログラム ===\n")
    
    # サンプル行列の作成
    matrix_a = Matrix4x4([
        [1, 2, 3, 4],
        [5, 6, 7, 8],
        [9, 10, 11, 12],
        [13, 14, 15, 16]
    ])
    
    matrix_b = Matrix4x4([
        [2, 0, 1, 3],
        [1, 1, 0, 2],
        [0, 1, 2, 1],
        [1, 0, 1, 1]
    ])
    
    print("行列 A:")
    print(matrix_a)
    
    print("行列 B:")
    print(matrix_b)
    
    # 加算
    print("A + B:")
    result_add = matrix_a.add(matrix_b)
    print(result_add)
    
    # 減算
    print("A - B:")
    result_sub = matrix_a.subtract(matrix_b)
    print(result_sub)
    
    # 乗算
    print("A × B:")
    result_mul = matrix_a.multiply(matrix_b)
    print(result_mul)
    
    # スカラー倍
    print("A × 2:")
    result_scalar = matrix_a.multiply(2)
    print(result_scalar)
    
    # 転置
    print("A の転置:")
    result_transpose = matrix_a.transpose()
    print(result_transpose)
    
    # 行列式
    print(f"A の行列式: {matrix_a.determinant():.2f}")
    print(f"B の行列式: {matrix_b.determinant():.2f}")
    
    # トレース
    print(f"A のトレース: {matrix_a.trace()}")
    print(f"B のトレース: {matrix_b.trace()}")
    
    # 逆行列（Bで試す）
    try:
        print("B の逆行列:")
        result_inverse = matrix_b.inverse()
        print(result_inverse)
        
        # 検証: B × B^(-1) = I
        print("検証 B × B^(-1):")
        identity_check = matrix_b.multiply(result_inverse)
        print(identity_check)
        
    except ValueError as e:
        print(f"逆行列計算エラー: {e}")

# 対話的な使用例
def interactive_example():
    print("\n=== 対話的な例 ===")
    
    # ユーザーが行列を入力できる関数
    def input_matrix():
        print("4x4行列を入力してください（行ごとに4つの数値をスペース区切りで入力）:")
        matrix = []
        for i in range(4):
            row = list(map(float, input(f"行 {i+1}: ").split()))
            if len(row) != 4:
                raise ValueError("各行に4つの数値を入力してください")
            matrix.append(row)
        return Matrix4x4(matrix)
    
    # 簡単な例として単位行列を作成
    identity = Matrix4x4([
        [1, 0, 0, 0],
        [0, 1, 0, 0],
        [0, 0, 1, 0],
        [0, 0, 0, 1]
    ])
    
    print("単位行列:")
    print(identity)
    
    # ランダム行列の例
    random_matrix = Matrix4x4(np.random.randint(1, 10, (4, 4)))
    print("ランダム行列:")
    print(random_matrix)

if __name__ == "__main__":
    main()
    interactive_example()
